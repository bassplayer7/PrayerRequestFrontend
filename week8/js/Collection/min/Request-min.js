define(["jquery","PubSub","evt","../Model/Request"],function($,e,t,n){var s=[],o="http://prayer.dev/bassplayer7/request/",u=function(n){$.ajax(o+"all",{method:"GET",dataType:"json"}).done(function(e,t){E(e,t,n)}).fail(function(n,s){e.publish(t.ERROR,{data:n,status:s}),e.publish(t.INITIALIZE_SYSTEM)})},E=function(n,s,o){if(n.hasOwnProperty("prayer_requests")){var u=n.prayer_requests;for(var E in u)i(u[E])}else e.publish(t.ERROR_UNKNOWN,s);o&&o(n)},i=function(o,u){return typeof o!==n&&(o=new n(o)),s.push(o),"new"===u?e.publish(t.REQUEST_NEW_ADD,o):e.publish(t.REQUEST_ADD,o),o},l=function(){this.buildInitialList=function(){u()},e.subscribe(t.REQUEST_NEW_INIT,this.requestNew.bind(this)),e.subscribe(t.REQUEST_DELETE_INIT,this.requestDelete.bind(this)),e.subscribe(t.REQUEST_ANSWERED_INIT,this.requestUpdate.bind(this)),e.subscribe(t.REQUEST_UPDATE_SAVE,this.requestUpdate.bind(this))};return l.prototype.requestNew=function(s,u){"object"==typeof s&&(u=s);var E=new n(u);$.ajax({url:o+"new",dataType:"json",method:"PUT",data:{prayer_request:E}}).done(function(n){E.Id=n.id,e.publish(t.REQUEST_NEW_COMPLETE,n),i(E,"new")}).fail(function(n){e.publish(t.REQUEST_NEW_ERROR,n)})},l.prototype.requestDelete=function(n,s){var u=this;$.ajax(o+"delete/"+s.model.Id,{dataType:"json",method:"DELETE"}).done(function(e,t){console.log(t),u.requestDeleteComplete(t,s.model,s.element)}).fail(function(n){e.publish(t.ERROR,n)})},l.prototype.requestDeleteComplete=function(n,o,u){for(var E in s)s[E]===o&&s.splice(E,1);e.publish(t.REQUEST_DELETE_COMPLETE,{status:n,model:o,element:u})},l.prototype.requestUpdate=function(n,s){var u=t.REQUEST_UPDATE_COMPLETE;n===t.REQUEST_ANSWERED_INIT&&(s.model.Answered=s.model.Answered?!1:!0,s.element=s.element.parents(".list-group-item"),u=t.REQUEST_ANSWERED_COMPLETE),$.ajax(o+"update/"+s.model.Id,{dataType:"json",method:"PUT",data:{prayer_request:s.model}}).done(function(t,n){e.publish(u,{status:n,element:s.element,model:s.model})}).fail(function(n,o){console.log(o),e.publish(t.ERROR_UPDATE,{response:n,model:s,element:s.element})})},l.prototype.requestAnswered=function(n,s){$.ajax(o+"update/"+s.model.Id,{dataType:"json",method:"PUT",data:{prayer_request:{Answered:s.model.Answered}}}).done(function(n,o){e.publish(t.REQUEST_ANSWERED_COMPLETE,{status:o,element:s.element,model:s.model})}).fail(function(n,o){console.log(o),e.publish(t.ERROR,{data:n,model:s})})},l});